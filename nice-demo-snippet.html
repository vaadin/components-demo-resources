<dom-module id="prism-theme-default">
  <template>
    <style>
    /**
     * GHColors theme by Avi Aryan (http://aviaryan.in)
     * Inspired by Github syntax coloring
     */

    code[class*="language-"],
    pre[class*="language-"] {
        color: #393A34;
        font-family: "Consolas", "Bitstream Vera Sans Mono", "Courier New", Courier, monospace;
        direction: ltr;
        text-align: left;
        white-space: pre;
        word-spacing: normal;
        word-break: normal;
        font-size: 0.95em;
        line-height: 1.2em;

        -moz-tab-size: 4;
        -o-tab-size: 4;
        tab-size: 4;

        -webkit-hyphens: none;
        -moz-hyphens: none;
        -ms-hyphens: none;
        hyphens: none;
    }

    pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
    code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
        background: #b3d4fc;
    }

    pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
    code[class*="language-"]::selection, code[class*="language-"] ::selection {
        background: #b3d4fc;
    }

    /* Code blocks */
    pre[class*="language-"] {
        padding: 1em;
        margin: .5em 0;
        overflow: auto;
        border: 1px solid #dddddd;
        background-color: white;
    }

    :not(pre) > code[class*="language-"],
    pre[class*="language-"] {
    }

    /* Inline code */
    :not(pre) > code[class*="language-"] {
        padding: .2em;
        padding-top: 1px; padding-bottom: 1px;
        background: #f8f8f8;
        border: 1px solid #dddddd;
    }

    .token.comment,
    .token.prolog,
    .token.doctype,
    .token.cdata {
        color: #999988; font-style: italic;
    }

    .token.namespace {
        opacity: .7;
    }

    .token.string,
    .token.attr-value {
        color: #e3116c;
    }
    .token.punctuation,
    .token.operator {
        color: #393A34; /* no highlight */
    }

    .token.entity,
    .token.url,
    .token.symbol,
    .token.number,
    .token.boolean,
    .token.variable,
    .token.constant,
    .token.property,
    .token.regex,
    .token.inserted {
        color: #36acaa;
    }

    .token.atrule,
    .token.keyword,
    .token.attr-name,
    .language-autohotkey .token.selector {
        color: #00a4db;
    }

    .token.function,
    .token.deleted,
    .language-autohotkey .token.tag {
        color: #9a050f;
    }

    .token.tag,
    .token.selector,
    .language-autohotkey .token.keyword {
        color: #00009f;
    }

    .token.important,
    .token.function,
    .token.bold {
        font-weight: bold;
    }

    .token.italic {
        font-style: italic;
    }
    </style>
  </template>
</dom-module>


<link rel="import" href="../polymer/polymer-element.html">
<!--
Importing “prism-highlighter.html” breaks document styles in IE and Edge,
see: https://github.com/webcomponents/webcomponentsjs/issues/799.

TODO(@platosha): Replace direct Prism usage here back with <prism-highlighter>
after the issue above is fixed.
-->
<!-- <link rel="import" href="../prism&#45;element/prism&#45;highlighter.html"> -->
<script src="../prism/prism.js" data-manual></script>
<link rel="import" href="../marked-element/marked-element.html">

<!--
`<nice-demo-snippet>` is a Polymer element displaying the provided HTML example
code with the hightlighted source below.

`<nice-demo-snippet>` is similar to `<demo-snippet>` element from the
PolymerElements/iron-demo-helpers.

Usage:

<nice-demo-snippet>
  <script type="text/html" slot="source">
    <h1>Hello, world!</h1>
  </script>
</nice-demo-snippet>

`<nice-demo-snippet>` expects `<script type="text/html">` child element defining
the source code, unlike the `<demo-snippet>`, which uses `<template>`.  This
allows to display the code snippet intact, exactly as it was written, preserving
line breaks, quotation symbols, JSON in HTML attributes, and so on.

Similarly to `<demo-snippet>`, The source is rendered in the light DOM,
allowing easy styling and scripting in the parent (document) scope.

@polymerElement
-->

<dom-module id="nice-demo-snippet">
  <template>
    <style is="custom-style" include="prism-theme-default"></style>
    <style>
      :host {
        display: block;
        position: relative;
        margin: 1em 0;
      }

      :host::after {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        border: 1px solid var(--nice-demo-snippet-border-color, rgba(0,0,0,0.1));
        pointer-events: none;
        border-radius: inherit;
      }

      .demo {
        padding: 1em;
        border-radius: inherit;
        overflow: hidden;
      }

      .view-code:checked ~ .demo {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
      }

      :host([code-only]) .demo,
      :host([code-only]) .view-code,
      :host([code-only]) .view-code + label,
      :host(:not([code-only])) .code {
        display: none;
      }

      .code {
        background-color: var(--nice-demo-snippet-code-background-color, rgba(0,0,0,0.03));
        color: inherit;
        padding: 0 1em;
        max-height: 20em;
        overflow: auto;
      }

      .code > pre {
        margin: 0 0 1.3em;
        font-size: 13px;
        line-height: 1.4;
        font-family: var(--nice-demo-snippet-code-font-family);
      }

      .view-code {
        opacity: 0;
        position: absolute;
      }

      .view-code:checked ~ marked-element .code.code {
        display: block;
      }

      .view-code + label {
        position: absolute;
        top: 1px;
        right: 1px;
        padding: 0.5em 1em;
        font-size: 13px;
        background-color: #fff;
        background-image: linear-gradient(var(--nice-demo-snippet-view-source-background-color, rgba(0,0,0,0.03)),
                                          var(--nice-demo-snippet-view-source-background-color, rgba(0,0,0,0.03)));
        color: inherit;
        border-bottom-left-radius: inherit;
        border-top-right-radius: inherit;
      }

      .view-code + label::before {
        content: "View ";
      }

      .view-code:checked + label::before {
        content: "Hide ";
      }

      .view-code:focus + label {
        box-shadow: var(--nice-demo-snippet-view-source-focus-box-shadow, 0 0 6px #257cff);
        border-radius: inherit;
      }
    </style>
    <input type="checkbox" class="view-code"><label>Source</label>
    <div class="demo">
      <slot></slot>
    </div>
    <marked-element id="markedElement">
      <div slot="markdown-html" class="code"></div>
    </marked-element>
    <slot name="source" id="sourceSlot" on-slotchange="_extractSource"></slot>
  </template>
  <script>
    (function() {
      class NiceDemoSnippetElement extends Polymer.Element {
        static get is() {
          return 'nice-demo-snippet';
        }

        static get properties() {
          return {
            _source: String,
            _demoRenderer: Element
          };
        }

        static get observers() {
          return [
            '_render(_source, _demoRenderer)'
          ];
        }

        ready() {
          super.ready();

          // iOS needs this, <label for="id"> doesn’t seem to work (facepalm)
          this.root.querySelector('input[type=checkbox] + label').addEventListener('click', function() {
            this.previousSibling.checked = !this.previousSibling.checked;
          });

          // <prism-highlighter>’s job.
          this.addEventListener('syntax-highlight', (event) => {
            if (event.detail && event.detail.code) {
              event.stopPropagation();
              const detail = event.detail;
              const lang = detail.lang && Prism.languages[detail.lang] || Prism.languages.markup;
              detail.code = Prism.highlight(detail.code, lang);
            }
          });
        }

        connectedCallback() {
          super.connectedCallback();

          this._extractSource();

          if (!this._demoRenderer) {
            const demoRenderer = document.createElement('div');
            this.appendChild(demoRenderer);
            this._demoRenderer = demoRenderer;
          }
        }

        disconnectedCallback() {
          super.disconnectedCallback();

          if (this._demoRenderer) {
            if (this._demoRenderer.parentNode) {
              this._demoRenderer.parentNode.removeChild(this._demoRenderer);
            }

            this._demoRenderer = null;
          }
        }

        _extractSource() {
          this._source = this.$.markedElement.unindent(
              this.$.sourceSlot.assignedNodes().map(node => {
                return node.innerHTML.replace(/=""/g, '');
              }).join('')
          );
        }

        _render(source, demoRenderer) {
          if (!source || !demoRenderer) return;

          this.$.markedElement.markdown = '```html\n' + source + '\n```';

          if (!this.hasAttribute("code-only")) {
            demoRenderer.innerHTML = source;
          }
        }
      }

      customElements.define(NiceDemoSnippetElement.is, NiceDemoSnippetElement);
    })();
  </script>
</dom-module>
